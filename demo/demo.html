<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyScheduler: Self-Evolving Scheduling Agent for Edge Computing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 更换为更现代的代码高亮主题 (VS Code Dark) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- 引入 Inter 字体，更有科技感 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* 全局字体优化 */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
            color: #334155; /* Slate-700 */
        }
        .code-font {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        /* 视频容器样式 - 增加圆角和阴影 */
        .video-wrapper {
            position: relative;
            background: #000;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .video-label {
            position: absolute;
            top: 12px; left: 12px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }

        /* 节点与连线动画 */
        .node-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .connector {
            height: 6px; /* 加粗线条 */
            background: #e2e8f0;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            transition: background 0.3s;
            border-radius: 4px;
        }

        /* 数据流动画 - 增强颜色 */
        .connector.flow::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            transform: translateX(-100%); animation: flow-anim 1.5s infinite linear;
        }
        .connector.telemetry-flow::after {
            background: linear-gradient(90deg, transparent, #10b981, transparent); /* Emerald 500 */
        }
        .connector.blocked { background: #fecaca; } /* Red 200 */
        .connector.blocked::after { animation: none; background: transparent; }

        @keyframes flow-anim { 100% { transform: translateX(100%); } }

        /* 节点变形高亮 */
        .morphing { animation: morph-highlight 0.6s ease-out; }
        @keyframes morph-highlight {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(59, 130, 246, 0.4); border-color: #3b82f6; }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* 滑块样式优化 */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #3b82f6; margin-top: -8px; cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #cbd5e1; border-radius: 4px; }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700">

    <!-- Header: 改为深色背景，提升专业感 -->
    <header class="h-16 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 z-20 shadow-lg flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                <i class="fas fa-gears text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-xl tracking-tight text-white leading-tight">PolyScheduler</h1>
                <div class="text-xs text-slate-400 font-medium tracking-wide">Self-Evolving Scheduling Agent for Edge Computing</div>
            </div>

            <!-- Agent Config -->
            <div class="ml-6 px-4 py-1.5 bg-slate-800/50 border border-slate-700 rounded-full flex items-center gap-2 cursor-pointer hover:bg-slate-700 transition-colors group">
                <i class="fas fa-robot text-blue-400 text-sm group-hover:text-white transition-colors"></i>
                <span class="text-xs font-mono text-slate-300 group-hover:text-white transition-colors">Agent: Qwen2.5-Coder-7B-Instruct</span>
            </div>
        </div>

        <!-- Pipeline Toggles: 增大点击区域 -->
        <div class="flex gap-4 text-sm font-medium">
            <div class="flex items-center pipeline-toggle static-pipeline px-4 py-2 rounded-lg transition-all" onclick="switchPipeline('static')" style="cursor: pointer; background: rgba(255,255,255,0.05); color: #94a3b8; border: 1px solid rgba(255,255,255,0.1);">
                <span class="w-2.5 h-2.5 rounded-full bg-slate-500 mr-2.5"></span>Traditional Scheduler (Static)
            </div>
            <div class="flex items-center pipeline-toggle dynamic-pipeline active px-4 py-2 rounded-lg transition-all" onclick="switchPipeline('dynamic')" style="cursor: pointer; background: rgba(59,130,246,0.2); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4);">
                <span class="w-2.5 h-2.5 rounded-full bg-blue-500 mr-2.5 shadow-[0_0_10px_#3b82f6] animate-pulse"></span>PolyScheduler (Dynamic)
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Left: Code Panel (Rewriting Logic) -->
        <!-- 侧边栏改为深色 VS Code 风格 -->
        <aside class="w-[450px] bg-[#1e1e1e] border-r border-slate-700 flex flex-col z-10 shadow-2xl relative transition-colors duration-500" id="code-panel">
            <div class="flex border-b border-[#333] bg-[#252526]">
                <button class="px-6 py-3 text-sm font-medium text-white border-b-2 border-blue-500 bg-[#1e1e1e]">
                    <i class="fab fa-python mr-2 text-yellow-400"></i>adaptive_scheduler.py
                </button>
                <div class="flex-1 flex justify-end items-center px-4">
                     <div class="px-2 py-1 bg-green-900/30 border border-green-700/50 rounded flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-[10px] font-bold text-green-400 tracking-wider" id="execution-indicator">LIVE EXECUTION</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 p-0 overflow-hidden relative group bg-[#1e1e1e]">
                <!-- 代码字体大小增加至 text-[13px] 或 text-sm -->
                <pre class="h-full w-full m-0 p-5 overflow-auto code-font text-[13px] leading-7 text-gray-300"><code class="language-python" id="code-display" style="background: transparent; padding: 0;">
def QualityAware_Scheduler(data_stream, resource_monitor):
    # Standard High-Bandwidth Scheduling Policy
    # 1. Resource Monitoring and Task Allocation
    while True:
        # Monitor current network resources
        bandwidth = resource_monitor.get_bandwidth()
        latency = resource_monitor.get_latency()

        # Process full data stream when resources available
        processed_data = full_visual_processing(data_stream.read())

        # Upload complete results when bandwidth is high
        upload_result = Cloud.upload_video(processed_data.video_output)
                </code></pre>

                <!-- AI Overlay -->
                <div id="ai-rewrite-overlay" class="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] hidden flex flex-col items-center justify-center z-5">
                    <div class="bg-slate-800 border border-blue-500/50 px-6 py-4 rounded-xl shadow-2xl flex flex-col items-center gap-3 transform scale-110">
                        <div class="w-12 h-12 rounded-full bg-blue-900/50 flex items-center justify-center border border-blue-500/30">
                             <i class="fas fa-magic text-blue-400 text-xl animate-pulse"></i>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-white text-lg">Optimizing Runtime</div>
                            <div class="text-blue-300 text-xs font-mono mt-1">Applying context-aware rewrite...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 py-2 bg-[#007acc] text-white text-xs flex justify-between items-center" id="code-status-bar">
                <span><i class="fas fa-code-branch mr-2"></i>main*</span>
                <span>Python 3.8.10</span>
            </div>
        </aside>

        <!-- Right: Visualization Canvas -->
        <main class="flex-1 flex flex-col relative bg-slate-50">

            <!-- Video Monitoring Area -->
            <!-- 增加高度占比，让视频更大 -->
            <div class="h-[55%] border-b border-slate-200 p-6 flex gap-6 bg-white shadow-sm">
                <!-- Input Video -->
                <div class="flex-1 video-wrapper group">
                    <div class="video-label"><i class="fas fa-database mr-2 text-blue-400"></i>RAW FEED</div>
                    <canvas id="canvas-input" class="w-full h-full object-cover opacity-90"></canvas>
                    <video id="video-input" src="input.mov" loop muted autoplay class="absolute inset-0 w-full h-full object-cover hidden" onerror="this.style.display='none'"></video>
                </div>

                <!-- Output Video -->
                <div class="flex-1 video-wrapper border-blue-500/30">
                    <div class="video-label border-blue-500/30 text-blue-100"><i class="fas fa-cogs mr-2 text-green-400"></i>VISUAL STREAM</div>

                    <!-- Dynamic Content Overlay -->
                    <div id="output-overlay-text" class="absolute inset-0 flex items-center justify-center hidden z-20 bg-slate-900/90 backdrop-blur-sm">
                         <div class="text-center p-6 border border-green-500/30 rounded-xl bg-green-900/10">
                             <i class="fas fa-terminal text-green-400 text-4xl mb-3"></i>
                             <div class="text-green-400 font-mono text-lg font-bold">Telemetry Mode Active</div>
                             <div class="text-slate-400 text-sm mt-2">Video stream suspended to save bandwidth</div>
                             <div class="mt-4 flex gap-4 justify-center">
                                 <div class="px-3 py-1 bg-slate-800 rounded text-xs text-green-300 border border-slate-700">Steer: -2.4°</div>
                                 <div class="px-3 py-1 bg-slate-800 rounded text-xs text-green-300 border border-slate-700">Conf: 98%</div>
                             </div>
                         </div>
                    </div>

                    <canvas id="canvas-output" class="w-full h-full object-cover opacity-90"></canvas>
                    <video id="video-output" src="output.mov" loop muted autoplay class="absolute inset-0 w-full h-full object-cover hidden" onerror="this.style.display='none'"></video>
                </div>
            </div>

            <!-- MetaScheduler Flow Diagram -->
            <div class="flex-1 relative flex flex-col justify-center p-8 bg-slate-50/50">
                <div class="absolute top-6 left-8 flex items-center gap-3">
                    <div class="h-8 w-1 bg-blue-500 rounded-full"></div>
                    <div>
                        <div class="text-xs font-bold text-slate-700 tracking-wider uppercase">SCHEDULER ARCHITECTURE</div>
<!--                        <div class="text-xs font-bold text-slate-400">Runtime Graph</div>-->
                    </div>
                    <span id="rewrite-badge" class="hidden ml-4 px-3 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded-full border border-amber-300 animate-pulse shadow-sm">
                        <i class="fas fa-bolt mr-1"></i>OPTIMIZED
                    </span>
                </div>

                <div class="flex items-center justify-center px-10 gap-8 h-full">

                    <!-- Node 1: Resource Monitor -->
                    <div class="node-card w-40 p-6 rounded-2xl text-center border border-slate-100">
                        <div class="w-12 h-12 mx-auto bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-500">
                             <i class="fas fa-network-wired text-2xl"></i>
                        </div>
                        <div class="text-sm text-slate-700 font-bold">Resource Monitor</div>
                        <div class="text-xs text-slate-400 mt-1">Bandwidth & Latency</div>
                    </div>

                    <!-- Line 1 -->
                    <div class="connector flow" id="conn-1"></div>

                    <!-- Node 2: Scheduler -->
                    <div id="node-algo" class="node-card w-64 p-6 border-2 border-blue-500 rounded-2xl text-center shadow-xl shadow-blue-500/10 z-10">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-[10px] px-3 py-1 rounded-full uppercase font-bold tracking-wide shadow-md" id="tag-algo">ADAPTIVE SCHEDULER</div>
                        <i class="fas fa-project-diagram text-slate-800 text-4xl mb-3 mt-1" id="icon-algo"></i>
                        <div class="text-base font-bold text-slate-800" id="text-algo">Adaptive Scheduler</div>
                        <div class="text-xs text-blue-600 font-medium mt-1 bg-blue-50 py-1 px-2 rounded-md inline-block" id="desc-algo">Dynamic Resource Allocation</div>
                    </div>

                    <!-- Line 2 -->
                    <div class="connector flow" id="conn-2"></div>

                    <!-- Node 3: Task Executor -->
                    <div id="node-uplink" class="node-card w-48 p-6 border-2 border-blue-500 rounded-2xl text-center shadow-xl shadow-blue-500/10 z-10">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-[10px] px-3 py-1 rounded-full uppercase font-bold tracking-wide shadow-md" id="tag-uplink">EXECUTION UNIT</div>
                        <i class="fas fa-tasks text-slate-800 text-3xl mb-3 mt-1" id="icon-uplink"></i>
                        <div class="text-sm font-bold text-slate-800" id="text-uplink">Task Executor</div>
                        <div class="text-xs text-blue-600 font-medium mt-1 bg-blue-50 py-1 px-2 rounded-md inline-block" id="desc-uplink">High/Low Bandwidth Mode</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Controls Footer -->
    <footer class="bg-white border-t border-slate-200 p-6 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex-shrink-0">
        <div class="max-w-6xl mx-auto flex gap-12 items-center">
            <div class="flex flex-col justify-center mr-4">
                <button onclick="resetSim()" class="text-sm font-medium bg-slate-100 hover:bg-slate-200 text-slate-600 border border-slate-300 px-6 py-3 rounded-lg transition-all active:scale-95 flex items-center gap-2 shadow-sm">
                    <i class="fas fa-redo-alt"></i> Reset Env
                </button>
            </div>

            <!-- Network Slider -->
            <div class="flex-1 group bg-slate-50 p-4 rounded-xl border border-slate-100 hover:border-blue-200 transition-colors">
                <div class="flex justify-between mb-3 items-center">
                    <label class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                            <i class="fas fa-wifi text-sm"></i>
                        </div>
                        Uplink Bandwidth
                    </label>
                    <span id="val-net" class="text-xs font-bold font-mono text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full border border-emerald-200">100 Mbps (5G)</span>
                </div>
                <input type="range" id="input-net" min="0" max="100" value="100" class="w-full h-2 rounded-lg cursor-pointer bg-slate-200 accent-blue-600">
                <div class="flex justify-between text-[10px] text-slate-400 mt-1 font-mono uppercase">
                    <span>Offline</span>
                    <span>4G/LTE</span>
                    <span>5G Ultra</span>
                </div>
            </div>

            <!-- Compute Selection -->
            <div class="flex-1 group bg-slate-50 p-4 rounded-xl border border-slate-100 hover:border-purple-200 transition-colors">
                <div class="flex justify-between mb-3 items-center">
                    <label class="text-sm font-bold text-slate-700 flex items-center gap-2">
                         <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center">
                            <i class="fas fa-microchip text-sm"></i>
                        </div>
                        Edge Compute Unit
                    </label>
                    <span id="val-cpu" class="text-xs font-bold font-mono text-purple-600 bg-purple-100 px-3 py-1 rounded-full border border-purple-200">Orin NX (High)</span>
                </div>
                <div class="relative">
                    <select id="select-cpu" class="w-full appearance-none bg-white text-slate-700 px-4 py-2.5 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm font-medium shadow-sm cursor-pointer">
                        <option value="100">NVIDIA Orin NX </option>
                        <option value="20">Raspberry Pi 4 </option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // --- Code Templates (不变) ---
        const CODE_ORIGINAL = `
def adaptive_scheduler(data_stream, resource_monitor):
    # Standard High-Bandwidth Scheduling Policy
    # 1. Resource Monitoring and Task Allocation
    while True:
        # Monitor current network resources
        bandwidth = resource_monitor.get_bandwidth()
        latency = resource_monitor.get_latency()

        # Process full data stream when resources available
        processed_data = full_visual_processing(data_stream.read())

        # Upload complete results when bandwidth is high
        upload_result = Cloud.upload_video(processed_data.video_output)
`;

        const CODE_NET_OPT = `
def LatencyAware_Scheduler(data_stream, resource_monitor):
    # REWRITTEN: LOW BANDWIDTH MODE
    # Logic: Switch to lightweight telemetry-only processing

    while True:
        # Monitor current network resources
        bandwidth = resource_monitor.get_bandwidth()
        latency = resource_monitor.get_latency()

        # Process only essential data when bandwidth is low
        essential_data = lightweight_processing(data_stream.read())

        # CHANGED: Send only critical telemetry, not full video
        telemetry = {
            "steering": essential_data.steering_value,
            "confidence": essential_data.confidence,
            "timestamp": essential_data.timestamp
        }
        upload_result = Cloud.send_telemetry(telemetry) # < 1KB/s
`;

        const CODE_CPU_OPT = `
def adaptive_scheduler(data_stream, resource_monitor):
    # REWRITTEN: LOW COMPUTE MODE
    # Logic: Simplified processing for low-power devices

    while True:
        # Monitor current compute resources
        available_cpu = resource_monitor.get_cpu_usage()
        available_memory = resource_monitor.get_memory()

        # Use simplified processing when compute is limited
        simple_result = simplified_processing(data_stream.read())

        # Reduced processing for low-power devices
        upload_result = Cloud.upload_simplified(simple_result)
`;

        // --- Elements ---
        const inputNet = document.getElementById('input-net');
        const selectCpu = document.getElementById('select-cpu');
        const valNet = document.getElementById('val-net');
        const valCpu = document.getElementById('val-cpu');

        const nodeAlgo = document.getElementById('node-algo');
        const nodeUplink = document.getElementById('node-uplink');
        const conn2 = document.getElementById('conn-2');
        const rewriteBadge = document.getElementById('rewrite-badge');
        const outputOverlay = document.getElementById('output-overlay-text');

        const codeDisplay = document.getElementById('code-display');
        const aiOverlay = document.getElementById('ai-rewrite-overlay');

        let currentState = 'original';

        function updateSim() {
            const net = parseInt(inputNet.value);
            const cpu = parseInt(selectCpu.value);

            // Labels
            updateLabels(net, cpu);

            // Update execution indicator based on bandwidth
            updateExecutionIndicator(net);

            if (currentPipeline === 'static') {
                codeDisplay.textContent = CODE_ORIGINAL;
                hljs.highlightElement(codeDisplay);
                aiOverlay.classList.add('hidden');

                if (net < 30) {
                    // document.querySelector('.video-label').innerHTML = '<i class="fas fa-database mr-1"></i>RAW FEED: <span class="text-red-400">Network Issue</span>';
                    document.querySelector('.video-label').innerHTML = '<i class="fas fa-database mr-1"></i>RAW FEED';
                } else {
                    document.querySelector('.video-label').innerHTML = '<i class="fas fa-database mr-1"></i>RAW FEED';
                }

                if (cpu < 40 || net < 30) {
                    document.querySelector('.video-label.text-blue-100').innerHTML = '<i class="fas fa-cogs mr-1"></i>VISUAL STREAM: <span class="text-red-400">Error</span>';
                    const videoOutput = document.getElementById('video-output');
                    const canvasOutput = document.getElementById('canvas-output');
                    if (videoOutput) videoOutput.classList.add('hidden');
                    if (canvasOutput) canvasOutput.classList.add('hidden');

                    if (outputOverlay) {
                        outputOverlay.classList.remove('hidden');
                        outputOverlay.innerHTML = '<div class="absolute inset-0 flex items-center justify-center z-20 bg-slate-900/80"><div class="text-center"><i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-2"></i><div class="text-red-400 font-mono text-sm">SCHEDULER ERROR</div><div class="text-slate-500 text-xs mt-1">Static scheduler failed</div></div></div>';
                    }
                } else {
                    document.querySelector('.video-label.text-blue-100').innerHTML = '<i class="fas fa-cogs mr-1"></i>VISUAL STREAM';
                    const videoOutput = document.getElementById('video-output');
                    const canvasOutput = document.getElementById('canvas-output');
                    if (videoOutput && !videoOutput.src) {
                        canvasOutput.classList.remove('hidden');
                    } else if (videoOutput && videoOutput.src) {
                        videoOutput.classList.remove('hidden');
                    }

                    if (outputOverlay) {
                        outputOverlay.classList.add('hidden');
                        outputOverlay.innerHTML = '';
                    }
                }
                updateVisuals('original');
            } else {
                let nextState = 'original';
                if (net < 30) nextState = 'net_opt';
                else if (cpu < 40) nextState = 'cpu_opt';

                if (nextState !== currentState) {
                    performRewrite(nextState);
                    currentState = nextState;
                }
                updateVisuals(nextState);
            }
        }

        function updateLabels(net, cpu) {
            valNet.textContent = net + " Mbps";
            valNet.className = net < 30 ? "text-xs font-bold font-mono text-red-600 bg-red-100 px-3 py-1 rounded-full border border-red-200" : "text-xs font-bold font-mono text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full border border-emerald-200";

            if (cpu == 100) {
                valCpu.textContent = "Orin NX (High)";
                valCpu.className = "text-xs font-bold font-mono text-purple-600 bg-purple-100 px-3 py-1 rounded-full border border-purple-200";
            } else if (cpu == 20) {
                valCpu.textContent = "Raspberry Pi (Low)";
                valCpu.className = "text-xs font-bold font-mono text-amber-600 bg-amber-100 px-3 py-1 rounded-full border border-amber-200";
            }
            selectCpu.value = cpu.toString();
        }

        function updateExecutionIndicator(net) {
            const indicator = document.getElementById('execution-indicator');
            if (net < 30) {
                indicator.textContent = 'LATENCY AWARE';
            } else {
                indicator.textContent = 'QUALITY AWARE';
            }
        }

        function performRewrite(state) {
            aiOverlay.classList.remove('hidden');

            setTimeout(() => {
                let code = CODE_ORIGINAL;
                if(state === 'net_opt') code = CODE_NET_OPT;
                if(state === 'cpu_opt') code = CODE_CPU_OPT;

                codeDisplay.textContent = '';
                typeCode(code, codeDisplay, () => {
                    hljs.highlightElement(codeDisplay);
                    setTimeout(() => {
                        aiOverlay.classList.add('hidden');
                    }, 1000);
                });
            }, 600);
        }

        function typeCode(code, element, callback) {
            let i = 0;
            const lines = code.split('\n');
            let currentText = '';

            function typeLine() {
                if (i < lines.length) {
                    const line = lines[i];
                    let j = 0;
                    currentText += (i > 0 ? '\n' : '') + (line || ' ');

                    function typeChar() {
                        if (j < line.length) {
                            element.textContent = currentText.substring(0, currentText.length - line.length + j) + line[j];
                            j++;
                            setTimeout(typeChar, Math.random() * 5 + 2); // Faster typing
                        } else {
                            element.textContent = currentText;
                            i++;
                            setTimeout(typeLine, Math.random() * 50 + 10);
                        }
                    }
                    typeChar();
                } else {
                    if (callback) callback();
                }
            }
            typeLine();
        }

        function updateVisuals(state) {
            if (currentPipeline === 'static') {
                morphNode(nodeUplink, {
                    text: "Full Upload", desc: "High Bandwidth Mode", icon: "fa-file-video", color: "blue", tag: "EXECUTION UNIT"
                });
                conn2.classList.remove('telemetry-flow'); conn2.classList.add('flow');
                rewriteBadge.classList.add('hidden');
                outputOverlay.classList.add('hidden');

                morphNode(nodeAlgo, {
                    text: "Adaptive Scheduler", desc: "Dynamic Resource Allocation", icon: "fa-project-diagram", color: "blue", tag: "ADAPTIVE SCHEDULER"
                });

                const net = parseInt(inputNet.value);
                if (net < 30) {
                    conn2.classList.remove('flow', 'telemetry-flow');
                    conn2.classList.add('blocked');
                } else {
                    conn2.classList.remove('blocked');
                    conn2.classList.add('flow');
                }
            } else {
                if (state === 'net_opt') {
                    morphNode(nodeUplink, {
                        text: "Telemetry Only", desc: "Lightweight Mode", icon: "fa-terminal", color: "green", tag: "EXECUTION UNIT"
                    });
                    conn2.classList.remove('flow'); conn2.classList.add('telemetry-flow');
                    rewriteBadge.classList.remove('hidden');
                    outputOverlay.classList.remove('hidden');

                    // Update overlay content specifically for net opt - Telemetry Packet Format
                    outputOverlay.innerHTML = '<div class="p-6 border border-green-500/30 rounded-xl bg-slate-900/90 backdrop-blur text-left max-w-xs"><div class="text-green-400 font-mono text-sm mb-2">TELEMETRY PACKET</div><div class="text-slate-300 font-mono text-xs space-y-1"><div>Packet ID: #8932</div><div>Steering: -2.45 rad</div><div>Velocity: 45 km/h</div><div>Latency: 18 ms</div><div class="text-red-400">Video payload dropped by scheduler</div></div></div>';

                } else {
                    morphNode(nodeUplink, {
                        text: "Full Upload", desc: "", icon: "fa-file-video", color: "blue", tag: "EXECUTION UNIT"
                    });
                    conn2.classList.remove('telemetry-flow'); conn2.classList.add('flow');
                    rewriteBadge.classList.add('hidden');
                    outputOverlay.classList.add('hidden');
                }

                if (state === 'cpu_opt') {
                    morphNode(nodeAlgo, {
                        text: "Lightweight Scheduler", desc: "Compute-Optimized", icon: "fa-bolt", color: "amber", tag: "ADAPTIVE SCHEDULER"
                    });
                } else {
                    morphNode(nodeAlgo, {
                        text: "Adaptive Scheduler", desc: "Dynamic Resource Allocation", icon: "fa-project-diagram", color: "blue", tag: "ADAPTIVE SCHEDULER"
                    });
                }
            }
        }

        function morphNode(el, data) {
            const currentText = el.querySelector('[id^="text-"]').textContent;
            if(currentText === data.text) return;

            el.classList.add('morphing');
            // Remove old color borders
            el.className = el.className.replace(/border-\w+-500/, `border-${data.color === 'amber' ? 'amber' : (data.color === 'green' ? 'emerald' : 'blue')}-500`);

            setTimeout(() => {
                const iconColorClass = data.color === 'blue' ? 'text-slate-800' : (data.color === 'green' ? 'text-emerald-600' : 'text-amber-600');
                el.querySelector('i').className = `fas ${data.icon} ${iconColorClass} text-4xl mb-3 mt-1`;

                el.querySelector('[id^="text-"]').textContent = data.text;

                const descEl = el.querySelector('[id^="desc-"]');
                descEl.textContent = data.desc;
                // Update Desc BG
                if(data.color === 'green') descEl.className = "text-xs text-emerald-700 font-medium mt-1 bg-emerald-50 py-1 px-2 rounded-md inline-block";
                else if(data.color === 'amber') descEl.className = "text-xs text-amber-700 font-medium mt-1 bg-amber-50 py-1 px-2 rounded-md inline-block";
                else descEl.className = "text-xs text-blue-600 font-medium mt-1 bg-blue-50 py-1 px-2 rounded-md inline-block";

                const tag = el.querySelector('div:first-child');
                tag.textContent = data.tag;
                let bg = data.color === 'blue' ? 'bg-blue-600' : (data.color === 'green' ? 'bg-emerald-600' : 'bg-amber-600');
                tag.className = `absolute -top-3 left-1/2 transform -translate-x-1/2 ${bg} text-white text-[10px] px-3 py-1 rounded-full uppercase font-bold tracking-wide shadow-md`;
            }, 200);

            setTimeout(() => el.classList.remove('morphing'), 600);
        }

        function resetSim() {
            inputNet.value = 100; selectCpu.value = "100";
            updateSim();

            if (document.querySelector('.video-label')) {
                document.querySelector('.video-label').innerHTML = '<i class="fas fa-database mr-1"></i>RAW FEED';
            }
            if (document.querySelector('.video-label.text-blue-100')) {
                document.querySelector('.video-label.text-blue-100').innerHTML = '<i class="fas fa-cogs mr-1"></i>VISUAL STREAM';
            }
            if (outputOverlay) {
                outputOverlay.classList.add('hidden');
            }
        }

        function initCanvasAnim() {
            const ctxIn = document.getElementById('canvas-input').getContext('2d');
            const ctxOut = document.getElementById('canvas-output').getContext('2d');

            let offset = 0;

            function draw() {
                offset = (offset + 4) % 40;

                // Input Canvas
                ctxIn.fillStyle = '#1e293b'; ctxIn.fillRect(0,0,300,150); // Slate-800
                ctxIn.strokeStyle = '#475569'; ctxIn.beginPath();
                ctxIn.moveTo(100, 75); ctxIn.lineTo(0, 150);
                ctxIn.moveTo(200, 75); ctxIn.lineTo(300, 150);
                ctxIn.stroke();

                ctxIn.strokeStyle = '#f59e0b'; ctxIn.setLineDash([10, 10]); // Amber-500
                ctxIn.beginPath(); ctxIn.moveTo(150, 75); ctxIn.lineTo(150, 150);
                ctxIn.lineDashOffset = -offset; ctxIn.stroke(); ctxIn.setLineDash([]);

                // Output Canvas
                ctxOut.fillStyle = '#0f172a'; ctxOut.fillRect(0,0,300,150); // Slate-900
                ctxOut.lineWidth = 4;
                ctxOut.strokeStyle = '#ef4444';
                ctxOut.beginPath(); ctxOut.moveTo(80, 0); ctxOut.lineTo(80, 150); ctxOut.stroke();
                ctxOut.strokeStyle = '#3b82f6';
                ctxOut.beginPath(); ctxOut.moveTo(220, 0); ctxOut.lineTo(220, 150); ctxOut.stroke();

                ctxOut.strokeStyle = '#10b981'; ctxOut.lineWidth = 2; // Emerald-500
                ctxOut.beginPath(); ctxOut.moveTo(150, 0); ctxOut.lineTo(150, 150); ctxOut.stroke();

                requestAnimationFrame(draw);
            }
            draw();
        }

        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightElement(codeDisplay);
            updateSim();
            initCanvasAnim();

            const staticToggle = document.querySelector('.static-pipeline');
            const dynamicToggle = document.querySelector('.dynamic-pipeline');

            staticToggle.style.background = 'rgba(255,255,255,0.05)';
            staticToggle.style.border = '1px solid rgba(255,255,255,0.1)';
            staticToggle.querySelector('span').style.background = '#64748b';
            staticToggle.querySelector('span').classList.remove('animate-pulse');

            dynamicToggle.style.background = 'rgba(59,130,246,0.2)';
            dynamicToggle.style.border = '1px solid rgba(59,130,246,0.4)';
            dynamicToggle.querySelector('span').style.background = '#3b82f6';
            dynamicToggle.querySelector('span').classList.add('animate-pulse');

            const vidIn = document.getElementById('video-input');
            const vidOut = document.getElementById('video-output');

            vidIn.oncanplay = () => { vidIn.classList.remove('hidden'); document.getElementById('canvas-input').classList.add('hidden'); };
            vidOut.oncanplay = () => { vidOut.classList.remove('hidden'); document.getElementById('canvas-output').classList.add('hidden'); };
        });

        inputNet.addEventListener('input', updateSim);
        selectCpu.addEventListener('change', updateSim);

        let currentPipeline = 'dynamic';

        function switchPipeline(mode) {
            currentPipeline = mode;
            const staticToggle = document.querySelector('.static-pipeline');
            const dynamicToggle = document.querySelector('.dynamic-pipeline');

            if (mode === 'static') {
                staticToggle.style.background = 'rgba(255,255,255,0.1)';
                staticToggle.querySelector('span').style.background = '#e2e8f0';

                dynamicToggle.style.background = 'rgba(59,130,246,0.05)';
                dynamicToggle.style.border = '1px solid rgba(59,130,246,0.1)';
                dynamicToggle.querySelector('span').classList.remove('animate-pulse');
            } else {
                staticToggle.style.background = 'rgba(255,255,255,0.05)';
                staticToggle.querySelector('span').style.background = '#64748b';

                dynamicToggle.style.background = 'rgba(59,130,246,0.2)';
                dynamicToggle.style.border = '1px solid rgba(59,130,246,0.4)';
                dynamicToggle.querySelector('span').classList.add('animate-pulse');
            }

            if (mode === 'static') {
                codeDisplay.textContent = CODE_ORIGINAL;
                hljs.highlightElement(codeDisplay);
                aiOverlay.classList.add('hidden');
            } else {
                updateSim();
            }
        }
    </script>
</body>
</html>
